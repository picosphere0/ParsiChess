<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>parsiChess || Dashboard</title>
    <!-- jQuery with integrity check -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" 
        integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" 
        crossorigin="anonymous"></script>
    <!-- Chess libraries -->
    <link rel="stylesheet" href="lib/chessboard-1.0.0.min.css">
    <script src="lib/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="lib/stockfish.js"></script>
    <link rel="stylesheet" href="./css/output.css">
    <style>
        /* Add these styles for highlighting squares */
        .highlight-white {
            box-shadow: inset 0 0 3px 3px yellow;
        }
        .highlight-black {
            box-shadow: inset 0 0 3px 3px yellow;
        }
    </style>
</head>
<body>
    <nav class="bg-gray-800 p-4">
        <div class="container mx-auto">
            <div class="flex justify-between items-center">
                <div class="text-white text-2xl font-bold">
                    ParsiChess
                </div>

                <div class="hidden md:flex space-x-6">
                    <a href="#" class="text-white hover:text-gray-300">Puzzles</a>
                    <a href="#" class="text-white hover:text-gray-300">Games</a>
                    <a href="#" class="text-white hover:text-gray-300">Review</a>
                </div>

                <button class="md:hidden text-white focus:outline-none" onclick="toggleMenu()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <div id="mobile-menu" class="hidden md:hidden mt-2">
                <div class="flex flex-col space-y-3">
                    <a href="#" class="text-white hover:text-gray-300 py-2">Puzzles</a>
                    <a href="#" class="text-white hover:text-gray-300 py-2">Games</a>
                    <a href="#" class="text-white hover:text-gray-300 py-2">Review</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-8 p-4">
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Chess Board -->
            <div class="flex-1">
                <div id="board1" style="width: 400px"></div>
            </div>

            <!-- Game Controls -->
            <div class="flex-1">
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h2 class="text-xl font-bold mb-4">Game Controls</h2>
                    <div class="space-y-4">
                        <div class="flex space-x-2">
                            <button id="startBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Start New Game</button>
                            <button id="undoBtn" class="bg-gray-500 text-white px-4 py-2 rounded">Undo Move</button>
                            <button id="flipBoardBtn" class="bg-purple-500 text-white px-4 py-2 rounded">Switch Sides</button>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700">Engine Difficulty (1-20)</label>
                            <input type="range" id="difficultySlider" min="1" max="20" value="10" 
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Beginner</span>
                                <span id="difficultyValue">10</span>
                                <span>Master</span>
                            </div>
                        </div>
                        <div id="status" class="mt-4 font-bold"></div>
                        <div id="engineOutput" class="mt-4 font-mono text-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var board = null;
        var game = new Chess();
        var $status = $('#status');
        var $engineOutput = $('#engineOutput');
        var stockfish = new Worker('lib/stockfish.js');
        var playerColor = 'w';
        var whiteSquareGrey = '#a9a9a9';
        var blackSquareGrey = '#696969';

        // Initialize Stockfish
        stockfish.postMessage('uci');
        stockfish.postMessage('isready');

        function removeGreySquares () {
            $('#board1 .square-55d63').css('background', '');
        }

        function greySquare (square) {
            var $square = $('#board1 .square-' + square);

            var background = whiteSquareGrey;
            if ($square.hasClass('black-3c85d')) {
                background = blackSquareGrey;
            }

            $square.css('background', background);
        }

        function onDragStart (source, piece, position, orientation) {
            if (game.game_over()) return false;
            
            // Only allow moving pieces of player's color
            if (piece.search(playerColor === 'w' ? /^b/ : /^w/) !== -1) return false;
        }

        function onMouseoverSquare (square, piece) {
            // Get list of possible moves for this square
            var moves = game.moves({
                square: square,
                verbose: true
            });

            // Exit if there are no moves available for this square
            if (moves.length === 0) return;

            // Highlight the square they moused over
            greySquare(square);

            // Highlight the possible squares for this piece
            for (var i = 0; i < moves.length; i++) {
                greySquare(moves[i].to);
            }
        }

        function onMouseoutSquare (square, piece) {
            removeGreySquares();
        }

        function getStockfishMove() {
            return new Promise((resolve) => {
                const depth = $('#difficultySlider').val();
                
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth ' + depth);

                stockfish.onmessage = function(event) {
                    const message = event.data;
                    $engineOutput.text(message);

                    if (message.includes('bestmove')) {
                        const move = message.split(' ')[1];
                        resolve(move);
                    }
                };
            });
        }

        async function makeStockfishMove() {
            if (game.game_over()) return;

            const move = await getStockfishMove();
        
            game.move({
                from: move.slice(0, 2),
                to: move.slice(2, 4),
                promotion: move.length === 5 ? move[4] : undefined
            });

            board.position(game.fen());
            updateStatus();
        }

        function onDrop (source, target) {
            removeGreySquares();

            var move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            updateStatus();
            window.setTimeout(makeStockfishMove, 250);
        }

        function onSnapEnd () {
            board.position(game.fen());
        }

        function updateStatus () {
            var status = '';
            var moveColor = 'White';

            if (game.turn() === 'b') {
                moveColor = 'Black';
            }

            if (game.in_checkmate()) {
                status = 'Game over, ' + moveColor + ' is in checkmate.';
            } else if (game.in_draw()) {
                status = 'Game over, drawn position';
            } else {
                status = moveColor + ' to move';
                if (game.in_check()) {
                    status += ', ' + moveColor + ' is in check';
                }
            }

            $status.html(status);
        }

        function startNewGame() {
            game = new Chess();
            board.start();
            updateStatus();
            
            if (playerColor === 'b') {
                window.setTimeout(makeStockfishMove, 250);
            }
        }

        var config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            onMouseoverSquare: onMouseoverSquare,
            onMouseoutSquare: onMouseoutSquare,
            orientation: 'white'
        };
        
        board = Chessboard('board1', config);
        updateStatus();

        // Event listeners
        $('#startBtn').on('click', startNewGame);

        $('#undoBtn').on('click', function() {
            game.undo();
            game.undo();
            board.position(game.fen());
            updateStatus();
        });

        $('#flipBoardBtn').on('click', function() {
            playerColor = playerColor === 'w' ? 'b' : 'w';
            board.orientation(playerColor === 'w' ? 'white' : 'black');
            startNewGame();
        });

        $('#difficultySlider').on('input', function() {
            $('#difficultyValue').text($(this).val());
        });

        function toggleMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        }
    </script>
</body>
</html>
